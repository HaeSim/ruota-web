#!/bin/sh

echo "ğŸ§ª ì»¤ë°‹ ì „ ê²€ì‚¬ ì‹œì‘..."

# lint-staged ì‹¤í–‰ (lint:fix, prettier:fix)
echo "ğŸ” ë¦°íŠ¸ ë° í¬ë§· ê²€ì‚¬ ì‹¤í–‰..."
pnpm lint-staged

# lint ë° í¬ë§· ê²€ì‚¬ (CIì™€ ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ)
echo "ğŸ” ì „ì²´ ë¦°íŠ¸ ê²€ì‚¬ ì‹¤í–‰..."
pnpm run lint || { echo "âŒ ë¦°íŠ¸ ê²€ì‚¬ ì‹¤íŒ¨"; exit 1; }

echo "ğŸ” ì „ì²´ í¬ë§· ê²€ì‚¬ ì‹¤í–‰..."
pnpm run prettier || { echo "âŒ í¬ë§· ê²€ì‚¬ ì‹¤íŒ¨"; exit 1; }

# ë‹¨ìœ„ ë° í†µí•© í…ŒìŠ¤íŠ¸
echo "ğŸ§ª ë‹¨ìœ„ ë° í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
pnpm run test || { echo "âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"; exit 1; }

# ìŠ¤í† ë¦¬ë¶ ê´€ë ¨ ì‘ì—… (ì„ íƒì )
if [[ "$SKIP_STORYBOOK" != "true" ]]; then
  # ìŠ¤í† ë¦¬ë¶ ë¹Œë“œ ì‹œë„ (ì„ íƒì  - ì‹¤íŒ¨í•´ë„ ì»¤ë°‹ ì§„í–‰)
  echo "ğŸ“š Storybook ë¹Œë“œ ì‹œë„..."
  if pnpm run build-storybook --quiet; then
    echo "âœ… Storybook ë¹Œë“œ ì„±ê³µ"
    
    # ì„ íƒì ìœ¼ë¡œ Storybook í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    if [[ "$SKIP_STORYBOOK_TEST" != "true" ]]; then
      echo "ğŸ§ª Playwright ë¸Œë¼ìš°ì € ì„¤ì¹˜ í™•ì¸..."
      pnpm playwright install --with-deps chromium
      
      echo "ğŸ§ª Storybook í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
      pnpm dlx concurrently -k -s first -n "SB,TEST" -c "magenta,blue" \
        "pnpm dlx http-server storybook-static --port 6006 --silent" \
        "pnpm dlx wait-on tcp:127.0.0.1:6006 && pnpm run test-storybook" || echo "âš ï¸ Storybook í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ (ë¬´ì‹œí•˜ê³  ì§„í–‰)"
    fi
  else
    echo "âš ï¸ Storybook ë¹Œë“œ ì‹¤íŒ¨ (ë¬´ì‹œí•˜ê³  ì§„í–‰)"
  fi
else
  echo "ğŸ” ìŠ¤í† ë¦¬ë¶ ê²€ì‚¬ ê±´ë„ˆëœ€ (SKIP_STORYBOOK=true)"
fi

# ëª¨ë“  í•„ìˆ˜ ê²€ì‚¬ê°€ í†µê³¼ë˜ì—ˆìŠµë‹ˆë‹¤
echo "âœ… ëª¨ë“  í•„ìˆ˜ ê²€ì‚¬ í†µê³¼, ì»¤ë°‹ ì§„í–‰"
